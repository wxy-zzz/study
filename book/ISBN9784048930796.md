# A/B テスト実践ガイド

## 序文
- トワイマンの法則 (Twyman's law)
    - *興味深かったり通常と異なっているように見える点は、たいていは何かが間違っている。* (*the more unusual or interesting the data, the more likely they are to have been the result of an error of one kind or another*)
        - [Wikipedia](https://en.wikipedia.org/wiki/Twyman%27s_law)

## 第 1 章 導入と動機付け
*1 つの正確な測定は、1000 の専門家の意見よりも価値がある。* - Admiral Grace Hopper

### なぜ実験をするのか。相関、因果そして信用性
- 実験デザインの質の評価の階層
    1. ランダム化コントロール実験のシステマティックレビュー
    1. ランダム化オンライン実験
    1. その他のコントロール実験（例: 自然実験）
    1. 観察研究（例: コホート、症例対照研究）
    1. ケーススタディ（グループ分析）、逸話、個人的な（専門家の）意見、HiPPO
- オンラインでのコントロール実験の特徴
    - 因果関係を高い確率で確立する科学的方法
    - 他の技術では検出しにくい小さい変化も検出可能
    - 予期せぬ変化も検出可能

### 有益なコントロール実験を円滑に実行するために必要不可欠なもの
1. 実験単位が存在し、異なる実験群に対して干渉しないように実験群への割り当てが可能であること。
1. 十分な実験単位が存在すること。
1. 主要なメトリクスが合意され、実用的に評価できること。
1. 変更が容易であること。

#### オンラインでのコントロール実験の実施を望む組織の原則
- 組織は、データに基づいた意思決定を行いたいと考えており、OEC を公式化している
    - 多くの場合、「その機能が主要な指標にプラスの影響を与えているか」どうかを無視して、「計画の達成率」を基準に成功を宣言する方が簡単だが、それはデータ駆動型ではない。
    - データ駆動型であるためには、組織は比較的短い期間（1 〜 2 週間）で容易に測定できる OEC を定義すべきである。
- 組織は、コントロール実験を実行し、その結果が信用できるものであることを保証するために、インフラストラクチャとテストに投資する意思がある
    - コントロール実験の実行では、その信頼性を確保することが重要であり、信頼できる数値をえるのは難しい。
- 組織は、アイデアの価値を評価するのが苦手であることを認識している
    - Bing や google では、アイデアが実際にメトリクスを改善できた成功率は 10 〜 20%。
        - *勝利は 1 インチずつ* (「Any Given Sunday」)

### オンラインでのコントロール実験の興味深い実例集
何かが起こると思っていたのに、そうならなかった場合は、重要なことを学んだことになる。

### 戦略、戦術、そしてそれらと実験との関係性
戦略から戦術までのあらゆるレベルで、組織の意思決定に情報を提供するために実験を実行し、戦略を OEC に要約しよう。

#### シナリオ 1: 事業戦略があり、実験するのに十分な数のユーザーがいるプロダクトがある
実験は、局所最適に向かった登り方を助ける。
戦略を持つことは実験を実行する上で非常に重要である。戦略が定義され、チームが OEC の最適化と改善を行う権限を与えられると、コントロール実験はインベーションを加速させる。
正しい戦略を得ることとは、正しい戦略を得るための方法について知り、その認識がそろった組織によってなされるもの。それはトップダウンに指示された意見をボトムアップの仕事と一致させること。OEC は、戦略を明確にし、どの機能を世に出すかを戦略的に調整するための完璧なメカニズム。極論すると、良い OEC がなければ資源の無駄。

実験のためにガードレールメトリクスを定義することは、組織が変更しないものを識別するために重要。
業務効率の改善は長期的な差別化や優位性を提供する。

#### シナリオ 2: プロダクトと戦略があるが、結果は方針の転換を検討する必要があることを示唆していた
ほとんどは現在の場所の「近く」に最適化する試みへの投資を行うべきだが、いくつかの急進的なアイデアも試してみるべき。
ほとんどの急進的なアイデアは失敗するが、稀な成功は、多くの失敗を補えるほどの大きな成功になることもあり、リスクと報酬のトレードオフで考える必要がある。
急進的なアイデアの実験で検討必要があること
- 実験の期間
    - UI の再設計のテストでは、短期的に観測される変化は、プライマシー効果や変化嫌悪による影響を受けるかも
    - 両面市場では、十分な規模でない限り、市場に影響を与えられないかも
- テストされるアイデアの数
    - 実験は単一の戦術を検証するが、戦術は戦略の一部でしかなく、単一の実験の失敗は必ずしも戦略自体が悪いことを示さない。
        - 一方で、多くの戦術が失敗する場合は「どんなに美しい戦略であっても、たまには結果に目を向けるべきである」について考えよう。

計画をうまく、忠実に、厳密に実行した結果、明確な欠陥があることが判明したことは「達成した失敗」。
MVP によるコントロール実験を実行してデータを収集し、反復することで、不確実性を大幅に削減することは可能。

## 第 2 章 実験の実行と分析 〜一連の流れと例〜
*事実が少ないと、意見が強くなる。* - Arnold Glasow

### 実験のセットアップ
ファネルの考え方は単純化しすぎているが、実験の設計と分析を通して考える上で有用。

### 仮設検定。統計的有意差を確立するもの
実験のサイズを適切に決定し、分析中に統計的有意性を計算するためには、統計的ばらつきを知る必要がある。
科学の世界では基準に 0.05 **未満**の p 値を使用している。
「統計的有意性」は、仮定した帰無仮説の下に偶然に起こった可能性がどれだけあり得るを測定するが、どのような変化が運用上重要なのかは決められない。0.2% の変更が重要なのか、2% の変更でさえ小さすぎるのかはビジネスの状況に依る。

### 実験デザイン
実験デザインのために決める必要があるもの
1. ランダム化単位
    - ユーザを単位にするのが極めて妥当かつよく用いられる
1. ターゲットにしたいランダム化単位の母集団
    - 言語、地理的な地域、プラットフォーム、デバイス種類などの特定の特性
1. 実験に必要な標本サイズ
    - 実験をセグメントごとに調査する場合などに備え、過剰な検出力を持つように設計しても良い
1. 実験を実施する期間
    - 平日と週末ではユーザの分布が異なる場合があるため、最低でも 1 週間は実験を実行することを推奨する。祝日なども考慮に値するだろう。

### 結果を解釈する
OEC を見る前に、実験が適切に実行されたことの確認のために、ガードレールメトリクスまたは不変性メトリクスを確認する。
不変性メトリクスが変化したのならば、測定された差異は、テストされた機能ではない他の変更からの結果である可能性が高い。

## Words
- エンゲージメント
    - ユーザとの結びつきの強さを表す指標。具体的に定義があるわけではない。([ref](https://dmlab.jp/adtech/new_tech/adtech150507_1.html))
- OEC (Overall Evaluation Criterion / 総合評価基準 / 応答変数 / 従属変数 / アウトカム / 評価 / フィットネスファンクション)
    - 実験の目的の定量的な測定のこと。単一のメトリクスを選択することが強く推奨されている。
- バランススコアカード
    - 10 以上の指標を考慮しながら業績評価を行う会計ツール
- パラメータ (Parameter / 因子 / 変数)
    - OEC や関心のあるメトリクスに影響を与えると考えられる制御可能な実験変数。一般的には単一のパラメータでの実験のデザインがされる。
- 多変量テスト (Multivariable tests / MVTs)
    - 複数のパラメータを同時に評価するテスト
- 実験群 (Variant)
    - テストされるユーザ体験のこと。
- ランダム化単位 (Randomization Unit)
    - 擬似乱数化によって、実験単位を各実験群へランダムに割り当てる。ユーザをランダム化単位として使用することを強く推奨。
- データインフォームド（data-informaed)
    - またはデータアウェア（data-aware）本書においては「データ駆動」と同義。
- DOM (Document Object Model)
    - 文書の構造をメモリ内に表現することで、ウェブページとスクリプトやプログラミング言語を接続するもの ([link](https://developer.mozilla.org/ja/docs/Web/API/Document_Object_Model))
- 業務効率: ライバルと同じような活動をよりうまく実施すること
- プライマシー効果
    - 最初に与えられた情報が印象に残って長期記憶に引き継がれやすく、後の評価に影響を及ぼす現象 ([link](https://makitani.net/shimauma/primacy-effect))
    - 例えば、旧機能の動作方法に慣れていること
- Strategic Integrity: 戦略的完全性
- アナロジー: 類推
- ベンチマーク: 比較のために用いる指標 ([ref](https://ja.wikipedia.org/wiki/%E3%83%99%E3%83%B3%E3%83%81%E3%83%9E%E3%83%BC%E3%82%AF))
- システマティックレビュー (系統的レビュー / systematic review)
    - 文献をくまなく調査し、コントロール実験のような質の高い研究のデータを、出版バイアスのようなデータの偏りを限りなく除き、分析を行うこと ([ref](https://ja.wikipedia.org/wiki/%E3%82%B7%E3%82%B9%E3%83%86%E3%83%9E%E3%83%86%E3%82%A3%E3%83%83%E3%82%AF%E3%83%BB%E3%83%AC%E3%83%93%E3%83%A5%E3%83%BC))
- メタアナリシス: 複数の研究の結果を統合し、より高い見地から分析すること、またはそのための手法や統計解析のこと ([ref](https://ja.wikipedia.org/wiki/%E3%83%A1%E3%82%BF%E3%82%A2%E3%83%8A%E3%83%AA%E3%82%B7%E3%82%B9))
- 情報の期待値（Expected Value of Information / EVI）: 追加情報が意思決定にどのように役立つかの表現
- マルチアームバンディット
    - 実験の進行に合わせて実験群へのトラフィック割り当てを動的に更新する手法。古典的な A/B 実験よりも効率的。ただし、単一の OEC が更新タイミングまでに明確に測定可能な状態が必要となる。悪い実験群を体験したユーザが不均等に他の実験群に分配されることによる潜在的なバイアスがある可能性もある。
- シッククライアント（thick client / ファットクライアント / fat client）: クライアントサーバモデルにおいて、サーバとは独立に豊富な機能を提供するクライアントコンピュータのこと。([ref](https://ja.wikipedia.org/wiki/%E3%83%95%E3%82%A1%E3%83%83%E3%83%88%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88))
- ファネル: 定義された目標につながる一連のイベントのマッピングと分析を行う手法 ([ref](https://ja.wikipedia.org/wiki/%E3%83%95%E3%82%A1%E3%83%8D%E3%83%AB%E5%88%86%E6%9E%90))
- 実験感度: 統計的に有意な差を検出する能力
- サンプルサイズ
    - 実験群内の実験単位の数
    - 母数と表記するのは誤用
- 統計的検出力
    - 実験群の間に意味のある差が本当にあるときにそれを検出できる確率。
    - 80 〜 90% の検出力を持つように実験を設計するのが一般的。
- 外的妥当性: 研究対象者から得られた研究結果を他の集団に当てはめても同様の臨床結果が得られること（[ref](https://www.quint-j.co.jp/web/keyword/keyword.php?no=38696)）
- 不変性メトリクス
    - コントロール群と介入群の間で変化してはならないメトリクス。2 種類ある。
        1. サンプルサイズやキャッシュヒット率などの、実験の信用度に関連したガードレールメトリクス。
        1. 組織にとって重要で、不変であると予想されるガードレールメトリクス。レイテンシなど。

- BBS (behavior-based-search)
- ガードレールメトリクス
- ネイティブデスクトップ

## Links
- https://experimentguide.com
- https://exp-platform.com
    - [Controlled experiments on the web: survey and practical guide](http://www.robotics.stanford.edu/~ronnyk/2009controlledExperimentsOnTheWebSurvey.pdf)
    - [Trustworthy Online Controlled Experiments: Five Puzzling Outcomes Explained](https://www.researchgate.net/publication/237838307_Trustworthy_Online_Controlled_Experiments_Five_Puzzling_Outcomes_Explained)
